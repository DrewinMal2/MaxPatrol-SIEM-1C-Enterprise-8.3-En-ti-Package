event Login_machine:
    key:
        recv_ipv4
    filter {
        (logon_auth_method == "remote" and subject == "account" and object == "session" and protocol.layer7 == "rdp" and action == "start")

    }

event Launch_mmc:
    key:
        recv_ipv4
    filter {
        (object.process.name == "mmc.exe" and subject == "account" and object == "process" and status == "success" and action == "start" and object.process.parent.name == "explorer.exe")

    }

event Brute_Force_Admin_Server:
    key:
        event_src.host
    filter {
        (subject.process.name == "mmc" and correlation_type == "incident" and correlation_name == "MMC_1C_BruteForce_AdminServer" )

    }

event Removing_Administrators:
    key:
        event_src.host
    filter {
        (action == "modify" and status == "success" and object.name == "eraseAgentUser" and object.type == "IServerClusterAdmin" and subject.process.name == "mmc" )

    }

event Create_Administrators:
    key:
        event_src.host
    filter {
        (action == "modify" and status == "success" and object.name == "insertAgentUser" and object.type == "IServerClusterAdmin" and subject.process.name == "mmc" )

    }

rule MMC_1C_Admin_Compromise:(Login_machine and Launch_mmc and Brute_Force_Admin_Server and Removing_Administrators[2] and Create_Administrators) within 15m

on Login_machine {
    $event_src.host = event_src.host
}

on Removing_Administrators {
    $subject.process.name = subject.process.name
}

on Create_Administrators {
    $object.name = object.name
}


emit {
    $correlation_name = "MMC_1C_Admin_Compromise"
    $correlation_type = "incident"

    $category.generic = "Attacks & Recon"
    $category.high = "Attack"
    $category.low = "Potential Attack"

    $id = "MMC_1C_Admin_Compromise"
    $importance = "high"

    $datafield12 = "MITRE ATT&CK Тактики: TA0001 Initial Access, TA0006 Credential Access, TA0040 Impact"

    $datafield13 = "MITRE ATT&CK Техники: T1021.001 Remote Services (RDP), T1110 Brute Force, T1078 Valid Accounts, T1531 Account Access Removal, T1098 Account Manipulation"


    $datafield14 = "Cyber Kill Chain: Step 1 Initial Access → Step 3 Exploitation → Step 7 Actions on Objectives"

    $datafield15 = "БДУ ФСТЭК: Группа способов:	СП.17 Подбор (восстановление) аутентификационной информации"
    $datafield16 = "БДУ ФСТЭК: Способ реализации: СП.17.1 Перебор паролей к учетной записи"

    $datafield17 = "БДУ ФСТЭК: Группа способов:	СП.2 Использование недостатков конфигурации"
    $datafield18 = "БДУ ФСТЭК: Способ реализации:	СП.2.11 Использование недостатков, связанных с некорректной настройкой прав доступа"

}
